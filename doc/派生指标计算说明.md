# 派生指标计算说明

```sql
SELECT
    account_no_in AS account_no, //account_no_in维度字段, account_no绑定维度
	SUM（amount） AS sum_amount //SUM聚合逻辑, amount就是原子指标的度量值, sum_amount指标名称
FROM 
	trade_detail  //trade_detail 数据明细宽表
WHERE
	amount > 1 //原子指标的前置过滤条件
AND
	trans_timestamp in （'2022-02-03 00:00:00', '2022-02-03 23:59:59'） 
				//基于时间字段（trans_timestamp）和时间聚合粒度（DAY和1）得到时间区间
GROUP BY 
	account_no //分组字段
```

### 聚合函数说明

聚合函数分为三类：数值型、对象型和集合型

|        | 输入数据                               | 输出数据          | 说明 |
| :----- | -------------------------------------- | ----------------- | ---- |
| 数值型 | 数值型                                 | 数值              |      |
| 对象型 | 比较字段、保留字段和原始数据           | 对象（JSON对象）  |      |
| 集合型 | 比较字段、排序字段、保留字段和原始数据 | 集合（List和Set） |      |
| 映射型 | key生成字段，聚合字段                  | 映射（Map）       |      |

数值型

输入的数据是数值型，且输出的数据也是数值型

- 最大值（MAX）: 计算指定数据集的最大值，如过去24小时最大交易金额; √
- 最小值（MIN）: 计算指定数据集的最小值，如过去 24 小时最小交易金额: √
- 求和（SUM）: 对指定数据集的对象进行累加，如金额求和; √
- 计数（COUNT）: 对指定数据集的记录条数进行计算，如交易次数: √
- 平均值（AVG）: 对指定数据集计算单笔平均值; √
- 递增（INCREASECOUNT）: 同一账号过去30天的交易序列中出现的递增次数; √
- 递减（DECREASECOUNT）: 同一账号过去30天的交易序列中出现的递减次数; √
- 最大连续递增（MAXINCREASECOUNT）: 同一账号过去30天的交易序列中出现的最大连续递增次数; √
- 最大连续递减（MAXDECREASECOUNT）: 同一账号过去30天的交易序列中出现的最大连续递减次数; √
- 最大连续次数（MAXCONTINUOUSCOUNT）: 交易金额最大连续次数; √
- 方差（VARS）: 同一账号过去30天的交易方差值; √
- 标准差（VARP）: 同一账号过去30天的交易标准差; √
- 协方差（COV）: 同一账号过去30天交易频率和交易金额的协方差; √
- 峰度系数: 用于衡量一组数据的尖峭程度，例如账户交易在某一日突增即可用峰度系数来剥量;
- 三阶中心炬: 同一账号过去30天的交易三阶中心矩值;
- 四阶中心炬: 同一账号过去30天的交易四阶中心矩值;

对象型

输入

- 上一笔（LAST）: 获得上一条数据记录的某个维度，如上一笔交易金额 √
- 最大对象（MAXOBJECT）: 同一账号过去30天的最大值交易明细（指定比较字段, 存储原始明细） √
- 最大字段（MAXFIELD）: 同一账号过去30天的交易最大金额的时间（指定比较字段, 存储指定字段） √
- 最小对象（MINOBJECT）: 同一账号过去30天的最小值交易明细（指定比较字段, 存储原始明细） √
- 最小字段（MINFIELD）: 同一账号过去30天的交易最小金额的时间（指定比较字段, 存储指定字段） √
- 占位对象（OCCUPIEDOBJECT）: 同一账号过去30天的首次交易明细（存储明细数据） √
- 占位字段（OCCUPIEDFIELD）: 同一账号过去30天的首次交易日期（存储指定字段） √
- 取代对象（REPLACEDOBJECT）: 同一账号过去30天的最近一次交易明细（存储明细数据） √
- 取代字段（REPLACEDFIELD）: 同一账号过去30天的最近一次交易日期（存储指定字段） √

集合型

- 对象列表（LISTOBJECT）: 同一账号过去30天的交易明细列表（存储原始明细） √
- 字段列表（LISTFIELD）: 同一账号过去30天的交易金额列表（存储指定字段） √
- 去重对象列表（DISTINCTLISTOBJECT）: 同一账号过去30天的去重交易明细列表（按照指定字段去重, 存储原始细） √
- 去重字段列表（DISTINCTLISTFIELD）: 同一账号过去30天的去重交易地点列表（按照指定字段去重, 存储指定段） √
- 对象排序列表（SORTEDLISTOBJECT）: 同一账号过去30天的交易明细列表（按照指定字段排序，存储原始明细） √
- 字段排序列表（SORTEDLISTFIELD）: 同一账号过去30天的交易金额列表（按照指定字段排序，存储指定字段） √
- 去重计数（DISTINCTCOUNT）: 在计数的基础上，按照指定字段进行去重 √

映射型

- 映射（MAP）: 同一账户过去30天所有交易账号的累计交易金额topN的交易账号列表

滑动计数（COUNTWINDOW）

- 最近5笔交易的聚合值: 同一账号过去30天中最近5笔交易的总金额 √

CEP

- 复杂事件序列（事件模式）: 账户过去24小时修改密码1分钟内进行转入交易，后30秒进行转出交易的次数; √



数值型（对表达式的值进行聚合计算、例如求和、平均、最大值、最小值，得到的是数值）

对象型（对表达式的值进行排序、，输出的是对象）

集合型（对表达式的值进行排序、去重，输出的是集合）

映射型（对表达式的值进行分组生成key，然后value的值进行聚合，输出的是映射）



1. 数值型聚合的值可以是表达式。例如SUM（IF（type = '张三', amount, 0））
2. 排序可以进行多表达式进行排序。例如ORDER BY （age + 1） ACS, age DESC
3. 去重可以进行多表达式去重。
4. 限制长度的逻辑和SQL的LIMIT语义一致。



聚合字段处理器逻辑梳理

数值型	通过表达式计算得到度量值，对度量值进行聚合运算。需要MetricFieldProcessor（度量值）

对象型	通过表达式计算得到比较字段（排序），需要MetricFieldProcessor（比较字段）和MetricFieldProcessor（保留字段）

集合型    通过表达式计算得到比较字段（排序和去重），需要MetricFieldProcessor（比较字段）和MetricFieldProcessor（保留字段）

映射型    通过表达式计算得到key的值，通过表达式计算得到value的值，value是数值类型的MergeUnit。需要MetricFieldProcessor（key）和AggregateNumberFieldProcessor（value）

滑动计数  需要子聚合处理器（输出的数据就是List<JSONObject>，进行二次聚合）

CEP	需要子聚合处理器（输出的数据就是List<JSONObject>，进行二次聚合）